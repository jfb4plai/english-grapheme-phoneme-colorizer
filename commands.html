<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Commands</title>
    
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>

<body>
    <script>
        // Global variables
        let isInWord = false;
        
        // Enhanced grapheme-phoneme mapping
        const graphemePhonemeMap = {
            // Vowel sounds with distinct colors
            'a': { color: '#FF6B6B' },     // cat, cake, car
            'e': { color: '#4ECDC4' },     // bed, see, her
            'i': { color: '#45B7D1' },     // bit, bite, bird
            'o': { color: '#96CEB4' },     // hot, boat, good
            'u': { color: '#FFEAA7' },     // but, boot, burn
            'y': { color: '#DDA0DD' },     // gym, my, happy
            
            // Common digraphs
            'th': { color: '#FF9FF3', weight: 'bold' }, // think, this
            'ch': { color: '#54A0FF', weight: 'bold' }, // chair
            'sh': { color: '#5F27CD', weight: 'bold' }, // ship
            'wh': { color: '#00D2D3', weight: 'bold' }, // what
            'ph': { color: '#FF6348', weight: 'bold' }, // phone
            'gh': { color: '#2ED573', weight: 'bold' }, // laugh, ghost
            'ck': { color: '#FFA502', weight: 'bold' }, // back
            'ng': { color: '#3742FA', weight: 'bold' }, // sing
            
            // Vowel combinations
            'ai': { color: '#FF7675' },  // rain
            'ay': { color: '#FF7675' },  // day
            'ea': { color: '#74B9FF' },  // sea, bread
            'ee': { color: '#0984E3' },  // see
            'ei': { color: '#6C5CE7' },  // eight, receive
            'ie': { color: '#A29BFE' },  // field, pie
            'oa': { color: '#FD79A8' },  // boat
            'oo': { color: '#FDCB6E' },  // moon, book
            'ou': { color: '#E17055' },  // house, soup
            'ow': { color: '#00B894' },  // cow, show
            'ue': { color: '#00CEC9' },  // true
            'ui': { color: '#55A3FF' },  // fruit
        };

        // Initialize Office Add-in (only if Office.js is available)
        if (typeof Office !== 'undefined') {
            Office.onReady(function(info) {
                console.log('Office.js loaded successfully');
                
                if (info.host === Office.HostType.Word) {
                    console.log('Word host detected - Functions ready');
                    isInWord = true;
                    
                    // Register functions globally for manifest commands
                    window.colorizeSelection = colorizeSelection;
                    window.clearFormatting = clearFormatting;
                } else {
                    console.log('Non-Word host detected');
                }
            });
        } else {
            console.log('Office.js not available - running in browser demo mode');
        }

        // Main colorization function
        function colorizeSelection() {
            console.log('colorizeSelection function called');
            
            if (!isInWord) {
                console.log('Not in Word - cannot colorize');
                return;
            }

            Word.run(function(context) {
                console.log('Starting Word.run');
                
                // Get the current selection
                const selection = context.document.getSelection();
                selection.load('text');
                
                return context.sync().then(function() {
                    const text = selection.text;
                    console.log('Selected text:', text);
                    
                    if (!text || text.trim() === '') {
                        console.log('No text selected');
                        return;
                    }
                    
                    // Apply colorization
                    applyGraphemePhonemeColoring(context, selection, text);
                    
                    return context.sync();
                }).then(function() {
                    console.log('Colorization completed successfully');
                });
                
            }).catch(function(error) {
                console.error('Error in colorizeSelection:', error);
            });
        }

        // Clear formatting function
        function clearFormatting() {
            console.log('clearFormatting function called');
            
            if (!isInWord) {
                console.log('Not in Word - cannot clear formatting');
                return;
            }

            Word.run(function(context) {
                const selection = context.document.getSelection();
                selection.load('text');
                
                return context.sync().then(function() {
                    if (!selection.text || selection.text.trim() === '') {
                        console.log('No text selected to clear');
                        return;
                    }
                    
                    // Clear font color and formatting
                    selection.font.color = '#000000';
                    selection.font.bold = false;
                    selection.font.highlightColor = null;
                    
                    return context.sync();
                }).then(function() {
                    console.log('Formatting cleared successfully');
                });
                
            }).catch(function(error) {
                console.error('Error in clearFormatting:', error);
            });
        }

        // Apply grapheme-phoneme coloring to text
        function applyGraphemePhonemeColoring(context, selection, text) {
            console.log('Applying colorization to:', text);
            
            // Split text into words and spaces
            const parts = text.split(/(\s+)/);
            let currentRange = selection.getRange();
            let currentIndex = 0;
            
            parts.forEach(function(part) {
                if (part.trim() === '') {
                    // Skip whitespace
                    currentIndex += part.length;
                    return;
                }
                
                // Create range for this word
                const wordRange = selection.getRange();
                wordRange.start = currentIndex;
                wordRange.end = currentIndex + part.length;
                
                // Apply coloring to the word
                colorizeWord(wordRange, part.toLowerCase());
                
                currentIndex += part.length;
            });
        }

        // Colorize individual word
        function colorizeWord(range, word) {
            console.log('Colorizing word:', word);
            
            // Remove punctuation for analysis
            const cleanWord = word.replace(/[^\w]/g, '');
            
            // Apply colors based on grapheme patterns
            // Sort by length (longest first) to avoid conflicts
            const sortedGraphemes = Object.keys(graphemePhonemeMap).sort((a, b) => b.length - a.length);
            
            for (const grapheme of sortedGraphemes) {
                if (cleanWord.includes(grapheme)) {
                    const properties = graphemePhonemeMap[grapheme];
                    
                    // Apply color
                    range.font.color = properties.color;
                    
                    // Apply bold if specified
                    if (properties.weight === 'bold') {
                        range.font.bold = true;
                    }
                    
                    // Only apply the first matching pattern to avoid conflicts
                    break;
                }
            }
        }

        // Export functions for global access
        if (typeof module !== 'undefined' && module.exports) {
            module.exports = {
                colorizeSelection: colorizeSelection,
                clearFormatting: clearFormatting
            };
        }
        
        // Also add to window for direct access
        if (typeof window !== 'undefined') {
            window.colorizeSelection = colorizeSelection;
            window.clearFormatting = clearFormatting;
        }
    </script>
</body>
</html>
